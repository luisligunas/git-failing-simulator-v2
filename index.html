<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>HTML ⇄ WebView Events (iOS & Android)</title>
  <style>
    body { font-family: -apple-system, system-ui, Arial, sans-serif; margin: 24px; }
    h1 { margin-bottom: 8px; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; cursor: pointer; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; margin: 16px 0; }
    .card { border: 1px solid #e5e5e5; border-radius: 16px; padding: 16px; flex: 1 1 320px; }
    #log { white-space: pre-wrap; border: 1px solid #eee; border-radius: 12px; padding: 12px; background: #fafafa; height: 220px; overflow: auto; }
    code { background: #f1f1f1; padding: 0 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>HTML ⇄ WebView Events (iOS & Android)</h1>
  <p>This page can send events to native and receive events from native on both iOS and Android, plus demo custom DOM events.</p>

  <div class="row">
    <!-- 1) JS ➜ Native -->
    <div class="card">
      <h3>Send message to native (JS ➜ Native)</h3>
      <p>Uses a unified <code>NativeBridge.send(payload)</code> that auto-detects iOS/Android.</p>
      <button id="btnSendToNative">Send “ping”</button>
      <p style="font-size: 13px;opacity:.75">
        Expected native endpoints:
        <br>• iOS: <code>window.webkit.messageHandlers.iosBridge.postMessage(json)</code>
        <br>• Android (JSI): <code>window.AndroidBridge.postMessage(jsonString)</code> or <code>window.Android.postMessage(jsonString)</code>
        <br>• Android (React Native): <code>window.ReactNativeWebView.postMessage(jsonString)</code>
      </p>
    </div>

    <!-- 2) Native ➜ JS -->
    <div class="card">
      <h3>Listen for native event (Native ➜ JS)</h3>
      <p>Listens for <code>nativeEvent</code> on <code>window</code>, and also RN’s <code>message</code>.</p>
      <button id="btnSimulateNativeEvent">Simulate native event (for browser testing)</button>
      <p style="font-size: 13px;opacity:.75">
        Native can dispatch any of the following:
        <br>• DOM: <code>window.dispatchEvent(new CustomEvent('nativeEvent', { detail: { msg: 'hi' } }))</code>
        <br>• Call: <code>window.receiveFromNative({ msg: 'hi' })</code>
        <br>• RN → Web: <code>webViewRef.postMessage(JSON.stringify({ type:'nativeEvent', detail:{ msg:'hi' }}))</code>
      </p>
    </div>

    <!-- 3) In-page event bus demo -->
    <div class="card">
      <h3>In-page custom events (JS ⇄ JS)</h3>
      <p>Dispatches and listens to <code>user-action</code> on <code>document</code>.</p>
      <button id="btnUserAction">Dispatch “user-action”</button>
      <p style="font-size: 13px;opacity:.75">
        Useful when you want loose coupling between parts of the page.
      </p>
    </div>
  </div>

  <h3>Log</h3>
  <div id="log"></div>

  <script>
    // --------- Utilities ----------
    function log(...args) {
      const line = args.map(v => {
        try { return typeof v === 'string' ? v : JSON.stringify(v); }
        catch { return String(v); }
      }).join(' ');
      const el = document.getElementById('log');
      el.textContent += `• ${line}\n`;
      el.scrollTop = el.scrollHeight;
      console.log('[LOG]', ...args);
    }

    // --------- Cross-platform Native Bridge ----------
    (function initNativeBridge(){
      // Detect platforms/bridges we support
      const isIOS = !!(window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.iosBridge);
      const hasAndroidBridge = typeof window.AndroidBridge === 'object';
      const hasAndroid = typeof window.Android === 'object';
      const isReactNativeWV = typeof window.ReactNativeWebView === 'object';

      // Create a unified sender
      function sendToNative(payload) {
        // Prefer object → string only when needed
        const asString = JSON.stringify(payload);

        if (isIOS) {
          try {
            window.webkit.messageHandlers.iosBridge.postMessage(payload);
            log('JS ➜ iOS postMessage:', payload);
            return true;
          } catch (e) {
            log('❌ iOS postMessage failed:', String(e));
            return false;
          }
        }

        // Android (classic addJavascriptInterface) usually requires strings
        if (hasAndroidBridge && typeof window.AndroidBridge.postMessage === 'function') {
          try {
            window.AndroidBridge.postMessage(asString);
            log('JS ➜ AndroidBridge.postMessage:', payload);
            return true;
          } catch (e) {
            log('❌ AndroidBridge.postMessage failed:', String(e));
            return false;
          }
        }
        if (hasAndroid && typeof window.Android.postMessage === 'function') {
          try {
            window.Android.postMessage(asString);
            log('JS ➜ Android.postMessage:', payload);
            return true;
          } catch (e) {
            log('❌ Android.postMessage failed:', String(e));
            return false;
          }
        }

        // React Native WebView bridge
        if (isReactNativeWV && typeof window.ReactNativeWebView.postMessage === 'function') {
          try {
            window.ReactNativeWebView.postMessage(asString);
            log('JS ➜ RN postMessage:', payload);
            return true;
          } catch (e) {
            log('❌ RN postMessage failed:', String(e));
            return false;
          }
        }

        log('⚠️ No native bridge found. Are you in a normal browser?');
        return false;
      }

      // Expose a small, typed bridge for app code
      window.NativeBridge = {
        env: {
          ios: isIOS,
          android: hasAndroid || hasAndroidBridge || isReactNativeWV,
          rn: isReactNativeWV
        },
        send: sendToNative
      };
    })();

    // Convenience (kept for backwards-compat iOS checks)
    function safeIOSBridge() {
      return window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.iosBridge;
    }

    // --------- JS ➜ Native ----------
    document.getElementById('btnSendToNative').addEventListener('click', () => {
      const payload = { type: 'ping', time: new Date().toISOString(), data: { from: 'JS' } };
      window.NativeBridge.send(payload);
    });

    // --------- Native ➜ JS (CustomEvent) ----------
    // Native can call: window.dispatchEvent(new CustomEvent('nativeEvent', { detail: {...} }))
    window.addEventListener('nativeEvent', (ev) => {
      log('Native ➜ JS (CustomEvent):', ev.detail);
      // Example: respond back to native when certain messages arrive
      if (ev.detail && ev.detail.request === 'version') {
        const info = { app: 'WebView Events Demo', version: '1.1.0' };
        // Reply via unified bridge
        window.NativeBridge.send({ type: 'version-response', info });
        log('JS ➜ Native (auto-response):', info);
      }
    });

    // --------- Native ➜ JS (direct function call) ----------
    // iOS/Android can directly call this via evaluateJavascript(...)
    window.receiveFromNative = function(data) {
      // Accept object or JSON string
      let payload = data;
      if (typeof data === 'string') {
        try { payload = JSON.parse(data); } catch { /* keep as string */ }
      }
      log('Native ➜ JS (function call):', payload);
      // Optionally, bubble it as a DOM event too:
      window.dispatchEvent(new CustomEvent('nativeEvent', { detail: payload }));
    };

    // --------- Native ➜ JS (React Native "message" event) ----------
    // React Native's WebView sends messages into the page via 'message' event.
    window.addEventListener('message', (ev) => {
      // RN puts the payload on ev.data
      let data = ev.data;
      try {
        const parsed = typeof data === 'string' ? JSON.parse(data) : data;
        data = parsed;
      } catch { /* not JSON, use as-is */ }

      if (data && (data.type || data.detail)) {
        log('Native ➜ JS (RN message):', data);
        // Normalize to our CustomEvent channel
        window.dispatchEvent(new CustomEvent('nativeEvent', { detail: data.detail ?? data }));
      } else {
        log('Native ➜ JS (RN message, raw):', data);
      }
    });

    // For testing in a desktop browser (no native layer)
    document.getElementById('btnSimulateNativeEvent').addEventListener('click', () => {
      const stub = { msg: 'Simulated event from native', ts: Date.now() };
      window.dispatchEvent(new CustomEvent('nativeEvent', { detail: stub }));
    });

    // --------- In-page custom events (JS ⇄ JS) ----------
    // Listener
    document.addEventListener('user-action', (e) => {
      log('In-page event received:', e.detail);
    });
    // Dispatcher
    document.getElementById('btnUserAction').addEventListener('click', () => {
      const detail = { action: 'button-click', at: new Date().toLocaleTimeString() };
      document.dispatchEvent(new CustomEvent('user-action', { detail }));
      log('In-page event dispatched:', detail);
    });

    // --------- Ready ---------
    log('Page ready. Bridge env:', window.NativeBridge.env);
    log('iOS legacy bridge available?', !!safeIOSBridge());
  </script>
</body>
</html>